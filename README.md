# 결제시스템

--------------------
## 사용기술
- 인텔리제이, Springboot 2.7.6 , JPA, H2 database, Swagger, Junit

## 설계
- 데이터베이스 설계
````
[결제 테이블]
create table payment (  
   id bigint generated by default as identity, --key 
   created_date timestamp,  --결제일
   modified_date timestamp, --결제 취소일   
   cancel_control_number varchar(20), -- 취소 관리번호(결제 취소 시)  
   control_number varchar(20),  -- 결제 관리번호 
   encrypt_card_info varchar(255),  -- 암호화된 카드정보
   installment integer not null,  -- 할부개월수
   price integer not null,  -- 결제/취소 금액
   status varchar(10),  -- 결제 상태(결제, 취소)
   string_data varchar(450),  -- 카드사로 보낼 string Data
   vat integer not null,  -- 부가가치세
   primary key (id)  
)

 alter table payment 
   add constraint UK_3dq92smhj1apvplgbxbf40t0n unique (control_number) --관리번호 중복 발생 X
````

````
[카드사 전달 string data 테이블]
create table delivery_card_company (
   id bigint generated by default as identity, -- key
   control_number varchar(20), -- 관리번호 
   string_data varchar(450), -- 카드사로 보낼 string data
   primary key (id)
)
````

## 문제해결 전략
### 1. 저장하는 string 데이터
- commonBody, commonHeader 클래스 구성 후 StringDataUtils 클래스를 통해 string data 생성

### 2. 부가가치세
- 자동계산 수식 : (int) Math.round(price / 11.0) 을 통해 소수점 1자리에서 반올림

### 3. 카드정보 암복호화
- 양방향 암호화 알고리즘 AES256 사용
- AES256Util.java 를 통한 카드정보 암,복호화
- 암,복호화 후 카드정보 저장을 위한 객체(CardInfo.java) 구현
### 4. 트랜젝션 데이터 관리
- 결제, 결제취소시 관리번호(unique id, 20자리) 생성
- 관리번호 생성 로직 : UUID.randomUUID().toString().replaceAll("-", "").substring(0, 20)
- 취소 데이터와 결제 데이터 연결 : Payment 엔티티 내 저장(컬럼으로 분리)
- 관리번호 조회 시 결제 혹은 결제취소 데이터 1건만 조회 : Payment 엔티티 조회 가능

### 5. 카드사 연결
- 향후 확장성을 고려하여 CardPolicy 인터페이스 생성
- 인터페이스 다형성을 통해 DBCardPolicy 클래스가 CardPolicy 상속받아 JPA Repository 연결
- DBCardPolicy에서 string 데이터를 h2 DB에 저장

## 필수 구현 API 기능 명세
### 1. 결제 API(POST /api/v1/pay)
- input : PayRequestDto(카드번호, 유효기간, cvc, 할부개월수, 결제금액, 부가가치세(optional))
- output : PayResponseDto(관리번호, 카드사에 전달한 string 데이터)
### 2. 결제취소 API(PUT /api/v1/pay)
- input : CancelRequestDto(관리번호, 취소금액, 부가가치세(optional))
- output : CancelResponseDto(관리번호, 카드사에 전달한 string data)

### 3. 결제정보 조회 API(GET /api/v1/pay)
- input : PaymentListRequestDto(관리번호)
- output : PaymentListResponseDto(관리번호, 카드정보(마스킹), 결제/취소 구분, 금액정보, 부가가치세)

### 4. API요청 실패 시
 ```
  ErrorCode.java 참조
 ```


  코드값|메시지|Http Status Code
  ---|---|---|
  NUMBER_NOT_FOUND|관리번호가 존재하지 않습니다|404
  ALREADY_SAVED_NUMBER|이미 존재하는 관리번호입니다. 다시 시도해주십시오|409
  ALREADY_CANCEL|이미 취소 처리된 데이터입니다|409
  INTERNAL_SERVER_ERROR|서버에서 오류가 발생했습니다.|500
  


### 5. Multi Thread 환경 대비
- 비관적락을 통한 구현 : **PaymentRepository.java**
 ```java
  @Lock(LockModeType.PESSIMISTIC_WRITE)
  Optional<Payment> findByControlNumber(String controlNumber);

  @Lock(LockModeType.PESSIMISTIC_WRITE)
  Optional<Payment> findByCancelControlNumber(String cancelControlNumber);
 ```
- Redisson을 통한 분산락 구현 : **PaymentService**
```java
  public void partialCancelByRedisson(CancelRequestDto dto) throws GeneralSecurityException, UnsupportedEncodingException{
    final RLock lock=redissonClient.getLock("partialCancel");
    try{
        if(!lock.tryLock(1,3,TimeUnit.SECONDS)){
        throw new CustomException(ErrorCode.INTERNAL_SERVER_ERROR);
        }
        partialCancel(dto);
    }catch(InterruptedException e){
        e.printStackTrace();
    }finally{
        if(lock!=null&&lock.isLocked()){
            lock.unlock();
        }
    }
  }
```

## 빌드 및 실행 방법
````
 $ git clone https://github.com/kakao-insurance-quiz/20221220-kbh.git
 $ cd 20221220-kbh/
 $ ./gradlew build
 $ cd build/libs
 $ java -jar payment-0.0.1-SNAPSHOT.jar
````